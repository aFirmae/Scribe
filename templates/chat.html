<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room - Scribe</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #0f1419 0%, #1a202c 100%);
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Message animations */
        .message-enter {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile sidebar */
        .sidebar-mobile {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .sidebar-mobile.open {
            transform: translateX(0);
        }

        /* Textarea auto-grow */
        .message-input {
            resize: none;
            min-height: 40px;
            max-height: 120px;
        }
        
        .glass-panel {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(55, 65, 81, 0.5);
        }
    </style>
</head>

<body class="gradient-bg h-screen overflow-hidden text-gray-100">

    <!-- Mobile Menu Toggle -->
    <button id="mobileMenuBtn"
        class="lg:hidden fixed top-4 left-4 z-50 bg-gray-800/80 p-3 rounded-xl shadow-lg text-emerald-400 hover:bg-gray-700 transition-colors border border-gray-700/50 backdrop-blur-sm">
        <i class="fas fa-bars text-xl"></i>
    </button>

    <!-- Main Container -->
    <div class="flex h-screen">

        <!-- Sidebar - Desktop: static, Mobile: overlay -->
        <div id="sidebar"
            class="sidebar-mobile lg:translate-x-0 fixed lg:static inset-y-0 left-0 z-40 w-80 glass-panel flex flex-col">

            <!-- Sidebar Header -->
            <div class="p-6 border-b border-gray-700/30">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 bg-gray-800/50 rounded-lg border border-gray-700/30">
                            <i class="fas fa-comments text-xl text-emerald-400"></i>
                        </div>
                        <span class="text-xl font-bold tracking-tight">Scribe</span>
                    </div>
                    <button id="closeSidebarBtn" class="lg:hidden text-gray-500 hover:text-gray-300 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Room Name -->
                <div class="flex items-center justify-between bg-gray-800/40 p-3 rounded-xl border border-gray-700/30">
                    <h2 id="roomName" class="text-base font-semibold truncate flex-1 text-gray-200"></h2>
                    <button id="editRoomNameBtn"
                        class="hidden ml-2 text-gray-500 hover:text-emerald-400 transition-colors">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </div>

            <!-- Room Code Section -->
            <div class="px-6 py-4 border-b border-gray-700/30">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-medium text-gray-500 mb-1 uppercase tracking-wider">Room Code</p>
                        <div class="flex items-center space-x-2">
                            <span id="roomCode" class="text-xl font-mono font-bold text-emerald-400 tracking-wider"></span>
                            <button id="copyCodeBtn" class="text-gray-500 hover:text-emerald-400 transition-colors p-1"
                                title="Copy code">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <button id="toggleCodeBtn" class="hidden text-gray-500 hover:text-gray-300 transition-colors p-2 hover:bg-gray-700/30 rounded-lg"
                        title="Toggle code visibility">
                        <i id="codeVisibilityIcon" class="fas fa-eye text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- User List -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4">
                <h3 class="text-xs font-semibold text-gray-500 mb-4 px-2 uppercase tracking-wider flex items-center justify-between">
                    <span>Participants</span>
                    <span id="userCount" class="bg-gray-800 px-2 py-0.5 rounded-full text-[10px]">0/5</span>
                </h3>
                <div id="userList" class="space-y-1">
                    <!-- Users will be inserted here -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="p-4 border-t border-gray-700/30 bg-gray-800/20">
                <!-- Host Actions (side by side) -->
                <div id="hostActions" class="hidden flex space-x-2 mb-3">
                    <button id="deleteRoomBtn"
                        class="flex-1 bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 font-medium py-2.5 rounded-xl transition-all flex items-center justify-center space-x-2">
                        <i class="fas fa-trash text-sm"></i>
                        <span>Delete</span>
                    </button>
                    <a href="/" id="hostLeaveBtn"
                        class="flex-1 bg-gray-700/50 hover:bg-gray-700 text-gray-300 border border-gray-600/30 font-medium py-2.5 rounded-xl transition-all flex items-center justify-center space-x-2">
                        <i class="fas fa-sign-out-alt text-sm"></i>
                        <span>Leave</span>
                    </a>
                </div>

                <!-- Non-host Leave Button (full width) -->
                <a href="/" id="nonHostLeaveBtn"
                    class="block w-full bg-gray-700/50 hover:bg-gray-700 text-gray-300 border border-gray-600/30 font-medium py-2.5 rounded-xl transition-all text-center group">
                    <i class="fas fa-sign-out-alt mr-2 group-hover:-translate-x-1 transition-transform"></i>Leave Room
                </a>
            </div>
        </div>

        <!-- Mobile Sidebar Overlay -->
        <div id="sidebarOverlay" class="lg:hidden hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-30 transition-opacity"></div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col h-screen relative">
            
            <!-- Chat Header (Mobile only) -->
            <div class="lg:hidden bg-gray-800/80 backdrop-blur-md p-4 pl-20 border-b border-gray-700/50 flex flex-col justify-center">
                <h2 id="roomNameMobile" class="text-lg font-semibold truncate leading-tight"></h2>
                <div class="flex items-center text-xs text-gray-400 mt-1">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 mr-2 animate-pulse"></span>
                    <span id="userCountMobile">0</span> participants
                </div>
            </div>

            <!-- Messages Container -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto custom-scrollbar p-4 lg:p-6 space-y-6">
                <!-- Grace Period Banner -->
                <div id="gracePeriodBanner" class="hidden bg-yellow-500/10 border border-yellow-500/20 text-yellow-500 px-4 py-3 rounded-xl mb-4 flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-clock mr-3 text-yellow-400"></i>
                        <div>
                            <p class="font-semibold text-sm">Host Disconnected</p>
                            <p class="text-xs text-yellow-500/80" id="gracePeriodText">Host rights will transfer in 10:00</p>
                        </div>
                    </div>
                </div>

                <!-- Messages will be inserted here -->
            </div>

            <!-- Message Input -->
            <div class="px-4 pb-4 pt-2">
                <div class="max-w-3xl mx-auto bg-gray-800/80 backdrop-blur-md border border-gray-700/50 rounded-full pl-4 pr-1.5 py-1.5 shadow-2xl flex items-center">
                    <form id="messageForm" class="flex-1 flex items-center space-x-2">
                        <div class="flex-1 relative">
                            <textarea id="messageInput" placeholder="Type a message..."
                                class="message-input w-full bg-transparent text-gray-100 placeholder-gray-500 border-none outline-none resize-none leading-normal text-sm flex items-center py-2"
                                rows="1" style="min-height: 40px; height: 40px;"></textarea>
                        </div>
                        <button type="submit"
                            class="w-8 h-8 bg-emerald-600 hover:bg-emerald-500 text-white rounded-full shadow-lg transition-all flex items-center justify-center flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95"
                            id="sendBtn">
                            <i class="fas fa-paper-plane text-xs translate-x-px translate-y-px"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Room Name Modal -->
    <div id="editRoomModal"
        class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800/95 rounded-3xl p-8 max-w-md w-full shadow-2xl border border-gray-700/50">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">Edit Room Name</h3>
            <form id="editRoomForm">
                <input type="text" id="newRoomName" maxlength="50" placeholder="Enter new room name"
                    class="w-full px-4 py-3 bg-gray-700/50 border border-gray-600/50 text-gray-100 placeholder-gray-500 rounded-xl focus:ring-2 focus:ring-emerald-500/50 focus:border-transparent outline-none mb-4">
                <div class="flex space-x-3">
                    <button type="button" onclick="closeEditRoomModal()"
                        class="flex-1 bg-gray-700/50 hover:bg-gray-700 text-gray-300 font-semibold py-2.5 rounded-xl transition-colors">
                        Cancel
                    </button>
                    <button type="submit"
                        class="flex-1 bg-emerald-600/90 hover:bg-emerald-600 text-white font-semibold py-2.5 rounded-xl hover:shadow-lg transition-all">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let roomCode = '{{ room_code }}';
        let username = '';
        let isHost = false;
        let isCodeVisible = true;

        // Get username from URL params
        const urlParams = new URLSearchParams(window.location.search);
        username = urlParams.get('username') || prompt('Enter your username:');

        if (!username) {
            window.location.href = '/';
        }

        // Initialize Socket.IO
        socket = io();

        // Mobile sidebar toggle
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('sidebarOverlay').classList.remove('hidden');
        });

        document.getElementById('closeSidebarBtn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.add('hidden');
        });

        document.getElementById('sidebarOverlay').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.add('hidden');
        });

        // Auto-grow textarea
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Handle Enter key (send message) and Shift+Enter (new line)
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('messageForm').dispatchEvent(new Event('submit'));
            }
        });

        // Socket event handlers will be added in the next file
        // (This is a placeholder - the actual implementation will be in the JavaScript file)
    </script>

    <!-- Load chat functionality -->
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
</body>

</html>