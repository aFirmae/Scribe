<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room - Scribe</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #5a5a5a;
        }

        /* Message animations */
        .message-enter {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Chat background - light grayish gradient */
        #messagesContainer {
            background: linear-gradient(180deg, #443a3a 0%, #302c2c 100%);
        }

        /* Mobile sidebar */
        .sidebar-mobile {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .sidebar-mobile.open {
            transform: translateX(0);
        }

        /* Textarea auto-grow */
        .message-input {
            resize: none;
            min-height: 44px;
            max-height: 120px;
        }
    </style>
</head>

<body class="bg-gray-800 h-screen overflow-hidden">

    <!-- Mobile Menu Toggle -->
    <button id="mobileMenuBtn"
        class="lg:hidden fixed top-4 left-4 z-50 bg-gray-700/80 p-3 rounded-full shadow-lg text-emerald-400 hover:bg-gray-700 transition-colors border border-gray-600/50">
        <i class="fas fa-bars text-xl"></i>
    </button>

    <!-- Main Container -->
    <div class="flex h-screen">

        <!-- Sidebar - Desktop: static, Mobile: overlay -->
        <div id="sidebar"
            class="sidebar-mobile lg:translate-x-0 fixed lg:static inset-y-0 left-0 z-40 w-80 bg-gray-800/95 border-r border-gray-700/50 flex flex-col">

            <!-- Sidebar Header -->
            <div class="gradient-bg p-6 text-white border-b border-gray-700/50">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-comments text-2xl text-emerald-400"></i>
                        <span class="text-xl font-bold">Scribe</span>
                    </div>
                    <button id="closeSidebarBtn" class="lg:hidden text-gray-500 hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Room Name -->
                <div class="flex items-center justify-between">
                    <h2 id="roomName" class="text-xl font-semibold truncate flex-1"></h2>
                    <button id="editRoomNameBtn"
                        class="hidden ml-2 text-gray-400 hover:text-gray-200 transition-colors">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </div>

            <!-- Room Code Section -->
            <div class="p-4 bg-gray-700/30 border-b border-gray-700/50">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-gray-500 mb-1">Room Code</p>
                        <div class="flex items-center space-x-2">
                            <span id="roomCode" class="text-xl font-bold text-emerald-400 tracking-wider"></span>
                            <button id="copyCodeBtn" class="text-emerald-400 hover:text-emerald-300 transition-colors"
                                title="Copy code">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <button id="toggleCodeBtn" class="hidden text-gray-500 hover:text-gray-400 transition-colors"
                        title="Toggle code visibility">
                        <i id="codeVisibilityIcon" class="fas fa-eye text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- User List -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4">
                <h3 class="text-sm font-semibold text-gray-500 mb-3 uppercase tracking-wider">
                    Participants (<span id="userCount">0</span>/5)
                </h3>
                <div id="userList" class="space-y-2">
                    <!-- Users will be inserted here -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="p-4 border-t border-gray-700/50">
                <!-- Host Actions (side by side) -->
                <div id="hostActions" class="hidden flex space-x-2 mb-3">
                    <button id="deleteRoomBtn"
                        class="flex-1 bg-red-600/80 hover:bg-red-600 text-white font-semibold py-2.5 rounded-lg transition-colors flex items-center justify-center space-x-2">
                        <i class="fas fa-trash"></i>
                        <span>Delete</span>
                    </button>
                    <a href="/" id="hostLeaveBtn"
                        class="flex-1 bg-gray-700/50 hover:bg-gray-700 text-gray-300 font-semibold py-2.5 rounded-lg transition-colors flex items-center justify-center space-x-2">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Leave</span>
                    </a>
                </div>

                <!-- Non-host Leave Button (full width) -->
                <a href="/" id="nonHostLeaveBtn"
                    class="block w-full bg-gray-700/50 hover:bg-gray-700 text-gray-300 font-semibold py-2.5 rounded-lg transition-colors text-center">
                    <i class="fas fa-sign-out-alt mr-2"></i>Leave
                </a>
            </div>
        </div>

        <!-- Mobile Sidebar Overlay -->
        <div id="sidebarOverlay" class="lg:hidden hidden fixed inset-0 bg-black/60 z-30"></div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col h-screen">

            <!-- Chat Header (Mobile only) -->
            <div class="lg:hidden gradient-bg text-white p-4 pl-16 border-b border-gray-700/50">
                <h2 id="roomNameMobile" class="text-lg font-semibold truncate"></h2>
                <p class="text-sm text-gray-400">
                    <span id="userCountMobile">0</span> participants
                </p>
            </div>

            <!-- Messages Container -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4">
                <!-- Messages will be inserted here -->
            </div>

            <!-- Message Input -->
            <div class="bg-gray-800/95 border-t border-gray-700/50 p-4">
                <form id="messageForm" class="flex items-end space-x-3">
                    <div class="flex-1 relative">
                        <textarea id="messageInput" placeholder="Type your message..."
                            class="message-input w-full px-4 py-3 pr-12 bg-gray-700/50 border border-gray-600/50 text-gray-100 placeholder-gray-500 rounded-2xl focus:ring-2 focus:ring-emerald-500/50 focus:border-transparent outline-none resize-none"
                            rows="1"></textarea>
                    </div>
                    <button type="submit"
                        class="bg-emerald-600/90 hover:bg-emerald-600 text-white p-3 rounded-full hover:shadow-lg transition-all flex-shrink-0 disabled:opacity-50 disabled:cursor-not-allowed"
                        id="sendBtn">
                        <i class="fas fa-paper-plane text-lg"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Room Name Modal -->
    <div id="editRoomModal"
        class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800/95 rounded-3xl p-8 max-w-md w-full shadow-2xl border border-gray-700/50">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">Edit Room Name</h3>
            <form id="editRoomForm">
                <input type="text" id="newRoomName" maxlength="50" placeholder="Enter new room name"
                    class="w-full px-4 py-3 bg-gray-700/50 border border-gray-600/50 text-gray-100 placeholder-gray-500 rounded-xl focus:ring-2 focus:ring-emerald-500/50 focus:border-transparent outline-none mb-4">
                <div class="flex space-x-3">
                    <button type="button" onclick="closeEditRoomModal()"
                        class="flex-1 bg-gray-700/50 hover:bg-gray-700 text-gray-300 font-semibold py-2.5 rounded-xl transition-colors">
                        Cancel
                    </button>
                    <button type="submit"
                        class="flex-1 bg-emerald-600/90 hover:bg-emerald-600 text-white font-semibold py-2.5 rounded-xl hover:shadow-lg transition-all">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let roomCode = '{{ room_code }}';
        let username = '';
        let isHost = false;
        let isCodeVisible = true;

        // Get username from URL params
        const urlParams = new URLSearchParams(window.location.search);
        username = urlParams.get('username') || prompt('Enter your username:');

        if (!username) {
            window.location.href = '/';
        }

        // Initialize Socket.IO
        socket = io();

        // Mobile sidebar toggle
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('sidebarOverlay').classList.remove('hidden');
        });

        document.getElementById('closeSidebarBtn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.add('hidden');
        });

        document.getElementById('sidebarOverlay').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.add('hidden');
        });

        // Auto-grow textarea
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Handle Enter key (send message) and Shift+Enter (new line)
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('messageForm').dispatchEvent(new Event('submit'));
            }
        });

        // Socket event handlers will be added in the next file
        // (This is a placeholder - the actual implementation will be in the JavaScript file)
    </script>

    <!-- Load chat functionality -->
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
</body>

</html>